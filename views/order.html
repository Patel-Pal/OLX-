<!-- order.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <title>Place Order</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container py-4">
        <h3 class="mb-4" id="btn">Confirm Order</h3>
        <div id="orderDetails" class="card p-4 shadow-sm"></div>

    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        const productId = localStorage.getItem("orderProductId");
        const products = JSON.parse(localStorage.getItem("products")) || [];
        const users = JSON.parse(localStorage.getItem("users")) || [];

        const product = products.find(p => p.id === productId);
        const seller = users.find(u => u.user_id === product?.seller_id);

        if (!product) {
            $('#orderDetails').html(`<p class="text-danger">Product not found.</p>`);
        } else {
            $('#orderDetails').html(`
        <div class="row">
            <div class="col-md-5">
                <img src="${product.image}" alt="${product.name}" class="img-fluid rounded border">
            </div>
            <div class="col-md-7">
                <h4>${product.name}</h4>
                <p><strong>Price:</strong> ‚Çπ${product.price}</p>
                <p><strong>Category:</strong> ${product.category}</p>
                <p><strong>Description:</strong> ${product.description}</p>
                <p><strong>Seller:</strong> ${seller?.name || 'Unknown'}</p>
                <button id="placeOrder" class="btn btn-success mt-3">Place Order</button>
            </div>
            <div class="text-end">
                <button class="btn btn-success" id="bill">Generate bill</button>
            </div>
        </div>
      `);
        }

        $(document).on("click", "#placeOrder", function () {
            const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
            const orders = JSON.parse(localStorage.getItem("orders")) || {};

            const orderKey = `${loggedInUser.user_id}_${productId}`;

            orders[orderKey] = {
                buyer_id: loggedInUser.user_id,
                product_id: productId,
                status: "pending"
            };

            localStorage.setItem("orders", JSON.stringify(orders));
            alert("Order placed. Waiting for seller approval...");
            location.reload();
        });


        const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
        const orders = JSON.parse(localStorage.getItem("orders")) || {};
        const orderKey = `${loggedInUser.user_id}_${productId}`;
        const userOrder = orders[orderKey];

        $("#bill").hide()
        if (userOrder?.status === 'pending') {
            $('#orderDetails').append(`<div class="alert alert-warning mt-3">Your order is <strong>pending</strong> seller confirmation.</div>`);
            $("#placeOrder").text("order pending")
            $("#placeOrder").hide()
            $("#bill").hide()
        } else if (userOrder?.status === 'accepted') {
            $('#orderDetails').append(`<div class="alert alert-success mt-3">üéâ Your order has been <strong>accepted</strong> by the seller!</div>`);
            $("#placeOrder").hide()
            $("#bill").show()
        } else if (userOrder?.status === 'rejected') {
            $('#orderDetails').append(`<div class="alert alert-danger mt-3">‚ùå Your order was <strong>rejected</strong> by the seller.</div>`);
            $("#placeOrder").hide()
            $("#bill").hide()
        }
        // console.log(products)

    </script>
</body>

</html>